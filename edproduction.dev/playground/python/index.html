<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Client-Side Executor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CodeMirror 5 Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .notebook-cell {
            transition: box-shadow 0.2s ease, transform 0.1s ease;
        }
        .notebook-cell:focus-within {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #3b82f6;
        }

        .output-text {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* CodeMirror Customization to match Notebook look */
        .CodeMirror {
            height: auto;
            min-height: 80px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            padding: 10px 0;
            background-color: #ffffff;
        }
        .CodeMirror-scroll {
            min-height: 80px;
        }

        /* Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-ready { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-loading { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .status-error { background-color: #ef4444; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* File Sidebar */
        #file-sidebar {
            position: fixed;
            right: -300px;
            top: 60px;
            bottom: 0;
            width: 300px;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        #file-sidebar.open { right: 0; }

        /* Matplotlib Canvas Overrides */
        .output-plot div { max-width: 100% !important; overflow-x: auto; box-shadow: none !important; }
        .output-plot canvas { max-width: 100% !important; height: auto !important; }

        /* Custom Modal */
        #custom-modal { backdrop-filter: blur(2px); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Sidebar / Header -->
    <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm z-10 shrink-0 h-[70px]">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-brands fa-python text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">PyBrowser Lite</h1>
                <div class="text-xs text-gray-500 flex items-center gap-2">
                    <span id="system-status-dot" class="status-dot status-loading"></span>
                    <span id="system-status-text">Initializing...</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <!-- Action Buttons -->
            <div class="flex bg-gray-100 rounded-lg p-1 gap-1 mr-2">
                <button onclick="triggerNotebookLoad()" class="px-3 py-1 text-sm text-gray-600 hover:bg-white hover:text-blue-600 rounded shadow-sm transition-all" title="Import .ipynb">
                    <i class="fa-solid fa-file-import"></i>
                </button>
                <button onclick="downloadNotebook()" class="px-3 py-1 text-sm text-gray-600 hover:bg-white hover:text-blue-600 rounded shadow-sm transition-all" title="Save as .ipynb">
                    <i class="fa-solid fa-file-export"></i>
                </button>
            </div>
            <input type="file" id="notebook-upload" class="hidden" accept=".ipynb" onchange="handleNotebookLoad(this)">

            <div class="h-6 w-px bg-gray-300 mx-1"></div>

             <button id="btn-upload" onclick="triggerUpload()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Upload File to FS" disabled>
                <i class="fa-solid fa-upload"></i>
            </button>
            <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">

            <button onclick="toggleFileSidebar()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition-colors relative" title="Show Files">
                <i class="fa-solid fa-folder"></i>
                <span id="file-count-badge" class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full hidden"></span>
            </button>

            <div class="h-6 w-px bg-gray-300 mx-1"></div>

            <button onclick="clearAll()" class="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded transition-colors" title="Reset Notebook">
                <i class="fa-solid fa-trash-can"></i>
            </button>
            <button onclick="addCell()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-medium transition-colors">
                <i class="fa-solid fa-plus mr-1"></i> Cell
            </button>
        </div>
    </div>

    <!-- File Sidebar -->
    <div id="file-sidebar">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h2 class="font-bold text-gray-700"><i class="fa-solid fa-hard-drive mr-2"></i>Files</h2>
            <button onclick="toggleFileSidebar()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="file-list">
            <div class="text-center text-gray-400 text-sm mt-10">No files found</div>
        </div>
        <div class="p-2 border-t border-gray-100 bg-gray-50 text-xs text-center text-gray-500">
            Files stored in memory (Virtual FS)
        </div>
    </div>

    <!-- Main Content -->
    <div id="notebook-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-20 relative">
        <!-- Cells will be injected here -->
    </div>

    <!-- Toast Notification -->
    <div id="toast">Message Here</div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border border-gray-200">
            <h3 id="modal-title" class="text-lg font-bold mb-2 text-gray-800">Title</h3>
            <p id="modal-message" class="text-gray-600 mb-6 text-sm leading-relaxed">Message goes here.</p>
            <div class="flex justify-end gap-3" id="modal-actions">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm font-medium transition-colors" onclick="closeModal()">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium shadow-sm transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="cell-template">
        <div class="notebook-cell bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden mb-6" data-id="">
            <div class="bg-gray-50 border-b border-gray-100 px-3 py-2 flex justify-between items-center select-none">
                <span class="text-xs font-mono text-gray-400 cell-index">In [ ]</span>
                <div class="flex gap-2">
                    <button class="run-btn text-gray-500 hover:text-green-600 transition-colors p-1" title="Run (Shift+Enter)">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Delete Cell">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <!-- CodeMirror Container -->
            <div class="editor-container border-b border-gray-100"></div>
            
            <div class="output-container hidden bg-gray-50">
                <div class="p-4 text-sm">
                    <div class="flex items-start gap-2">
                        <span class="text-xs font-mono text-red-400 mt-1 select-none output-label">Out:</span>
                        <div class="flex-1 overflow-hidden">
                            <div class="output-plot mb-2"></div>
                            <pre class="output-text text-gray-700"></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="loading-overlay absolute inset-0 bg-white/80 z-10 hidden flex items-center justify-center">
                <div class="loader"></div>
            </div>
        </div>
    </template>

    <template id="file-item-template">
        <div class="flex items-center justify-between p-2 hover:bg-blue-50 rounded group transition-colors cursor-default">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fa-regular fa-file-lines text-blue-400"></i>
                <span class="text-sm text-gray-700 font-mono truncate file-name">data.csv</span>
                <span class="text-xs text-gray-400 file-size"></span>
            </div>
            <button class="download-btn text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Download">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
    </template>

    <script>
        let pyodide = null;
        const STORAGE_KEY = 'py_notebook_data';
        
        // Registry for CodeMirror instances
        const editors = {};

        // --- Initialization ---
        async function main() {
            try {
                // Check URL for preview param first
                const urlParams = new URLSearchParams(window.location.search);
                const previewUrl = urlParams.get('preview');

                pyodide = await loadPyodide();
                await pyodide.runPythonAsync(`
                    import sys
                    import io
                    class JSStream(io.StringIO):
                        def write(self, s):
                            return super().write(s)
                `);
                
                document.getElementById('system-status-dot').className = 'status-dot status-ready';
                document.getElementById('system-status-text').innerText = 'Ready';
                document.getElementById('system-status-text').className = 'text-green-600 font-medium';
                document.getElementById('btn-upload').disabled = false;
                
                updateFileList();

                if (previewUrl) {
                    await handleUrlPreview(previewUrl);
                } else {
                    loadState();
                }

            } catch (err) {
                document.getElementById('system-status-dot').className = 'status-dot status-error';
                document.getElementById('system-status-text').innerText = 'Error';
                console.error("Pyodide failed to load", err);
                showModal("System Error", "Failed to load Python environment.", false);
            }
        }
        main();

        // --- URL Preview Logic ---
        async function handleUrlPreview(url) {
            showModal("Loading Preview", `Fetching notebook from: ${url}`, false);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const content = await response.json();
                
                closeModal();
                loadNotebookContent(content);
                showToast("Preview loaded from URL");
                
                // Disable auto-save when in preview mode to avoid overwriting local work?
                // For this lite version, we will let it save, assuming user wants to work on it.

            } catch (err) {
                console.error(err);
                let msg = err.message;
                if (msg.includes('Failed to fetch')) {
                    msg = "CORS Error: The URL blocked the request. Try a raw GitHub/Gist URL.";
                }
                showModal("Preview Failed", msg, false);
                // Fallback to local state
                loadState();
            }
        }

        // --- Modal Logic ---
        function showModal(title, message, isConfirm = false, onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const newConfirm = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);

            if (isConfirm) {
                cancelBtn.classList.remove('hidden');
                newConfirm.textContent = "Yes";
                newConfirm.onclick = () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                };
            } else {
                cancelBtn.classList.add('hidden');
                newConfirm.textContent = "OK";
                newConfirm.onclick = closeModal;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- File System Logic ---
        function toggleFileSidebar() {
            const sidebar = document.getElementById('file-sidebar');
            sidebar.classList.toggle('open');
            updateFileList();
        }
        function triggerUpload() { document.getElementById('file-upload').click(); }

        async function handleFileUpload(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const buffer = e.target.result;
                    const data = new Uint8Array(buffer);
                    pyodide.FS.writeFile(file.name, data);
                    showToast(`File "${file.name}" uploaded!`);
                    updateFileList();
                    document.getElementById('file-sidebar').classList.add('open');
                } catch (err) {
                    console.error(err);
                    showToast("Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = '';
        }

        function updateFileList() {
            if (!pyodide) return;
            const listContainer = document.getElementById('file-list');
            const template = document.getElementById('file-item-template');
            try {
                const files = pyodide.FS.readdir('.');
                const visibleFiles = files.filter(f => f !== '.' && f !== '..' && f !== 'tmp' && f !== 'home' && f !== 'dev' && f !== 'proc');
                if (visibleFiles.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm mt-10">No files found.<br>Upload or create one!</div>';
                    return;
                }
                listContainer.innerHTML = '';
                visibleFiles.forEach(filename => {
                    const clone = template.content.cloneNode(true);
                    clone.querySelector('.file-name').innerText = filename;
                    try {
                        const stat = pyodide.FS.stat(filename);
                        if(!pyodide.FS.isDir(stat.mode)) {
                             clone.querySelector('.file-size').innerText = `(${Math.ceil(stat.size/1024)}KB)`;
                        } else {
                            clone.querySelector('.file-size').innerText = '(Dir)';
                        }
                    } catch(e){}
                    clone.querySelector('.download-btn').onclick = () => downloadFile(filename);
                    listContainer.appendChild(clone);
                });
                const badge = document.getElementById('file-count-badge');
                if(visibleFiles.length > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch(e) {
                console.error("Error reading FS", e);
            }
        }

        function downloadFile(filename) {
            try {
                const content = pyodide.FS.readFile(filename);
                const blob = new Blob([content], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast("Error downloading: " + e.message);
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Jupyter Notebook Import/Export Logic ---
        function downloadNotebook() {
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                const id = cell.dataset.id;
                const source = editors[id].getValue(); // Get from CodeMirror
                cells.push({
                    "cell_type": "code",
                    "execution_count": null,
                    "metadata": {},
                    "outputs": [],
                    "source": source.split('\n').map(line => line + '\n')
                });
            });
            const notebook = {
                "metadata": {
                    "kernelspec": { "display_name": "Python 3 (Pyodide)", "language": "python", "name": "python3" },
                    "language_info": { "codemirror_mode": { "name": "ipython", "version": 3 }, "file_extension": ".py", "mimetype": "text/x-python", "name": "python", "nbconvert_exporter": "python", "pygments_lexer": "ipython3", "version": "3.8" }
                },
                "nbformat": 4,
                "nbformat_minor": 4,
                "cells": cells
            };
            const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notebook.ipynb';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Notebook downloaded");
        }

        function triggerNotebookLoad() { document.getElementById('notebook-upload').click(); }

        function handleNotebookLoad(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);
                    if (!content.cells) throw new Error("Invalid notebook format");
                    showModal("Import Notebook", "This will overwrite your current notebook. Are you sure?", true, () => {
                         loadNotebookContent(content);
                    });
                } catch (err) {
                    console.error(err);
                    showToast("Error parsing notebook: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function loadNotebookContent(content) {
             document.getElementById('notebook-container').innerHTML = '';
             localStorage.removeItem(STORAGE_KEY);
             
             // Clean up old editors
             for (const key in editors) delete editors[key];

             let loadedCount = 0;
             content.cells.forEach(cell => {
                if (cell.cell_type === 'code') {
                    let sourceCode = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
                    addCell(sourceCode, false);
                    loadedCount++;
                }
             });
             saveState();
             if (loadedCount === 0) {
                 addCell();
                 showToast("No code cells found");
             } else {
                 showToast(`Loaded ${loadedCount} cells`);
             }
        }

        // --- Core Logic ---
        function createCellElement(id, content = "") {
            const template = document.getElementById('cell-template');
            const clone = template.content.cloneNode(true);
            const cellDiv = clone.querySelector('.notebook-cell');
            cellDiv.dataset.id = id;
            
            // Initialize CodeMirror
            // We need to append to DOM first before initializing CM normally, 
            // or use the container method. Since we return the element, we'll find the container.
            
            const editorContainer = cellDiv.querySelector('.editor-container');
            
            // Delayed initialization to wait for DOM insertion
            setTimeout(() => {
                const cm = CodeMirror(editorContainer, {
                    value: content,
                    mode: "python",
                    theme: "eclipse",
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    viewportMargin: Infinity, // Allow auto-height
                    extraKeys: {
                        "Shift-Enter": function(cm) {
                            runCell(id);
                        },
                        "Tab": function(cm) {
                            // Proper spacing for tab
                            if (cm.somethingSelected()) {
                                cm.indentSelection("add");
                            } else {
                                cm.replaceSelection("    ", "end");
                            }
                        }
                    }
                });
                
                // Save on change
                cm.on("change", () => {
                   saveState(); 
                });

                editors[id] = cm;
            }, 0);

            cellDiv.querySelector('.run-btn').onclick = () => runCell(id);
            cellDiv.querySelector('.delete-btn').onclick = () => deleteCell(id);
            return cellDiv;
        }

        function addCell(content = "", save = true) {
            const id = "cell_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            const container = document.getElementById('notebook-container');
            const cellEl = createCellElement(id, content);
            container.appendChild(cellEl);
            
            if(save) {
                // Small delay to ensure CM is mounted
                setTimeout(() => {
                    cellEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    saveState();
                }, 50);
            }
            updateIndices();
        }

        async function runCell(id) {
            if (!pyodide) {
                showModal("Please Wait", "Python environment is still initializing.", false);
                return;
            }

            const cell = document.querySelector(`.notebook-cell[data-id="${id}"]`);
            if (!cell) return;

            // Get code from CodeMirror instance
            if (!editors[id]) return;
            const code = editors[id].getValue();

            const outputContainer = cell.querySelector('.output-container');
            const outputText = cell.querySelector('.output-text');
            const outputPlot = cell.querySelector('.output-plot');
            const loader = cell.querySelector('.loading-overlay');
            const label = cell.querySelector('.output-label');

            if (!code.trim()) return;

            loader.classList.remove('hidden');
            outputContainer.classList.add('hidden');
            outputText.textContent = "";
            outputPlot.innerHTML = ""; 
            
            try {
                await pyodide.runPythonAsync(`
                    sys.stdout = JSStream()
                    sys.stderr = JSStream()
                `);
                document.pyodideMplTarget = outputPlot;
                await pyodide.loadPackagesFromImports(code);
                
                let result = await pyodide.runPythonAsync(code);
                let stdout = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                let stderr = await pyodide.runPythonAsync("sys.stderr.getvalue()");
                let finalOutput = stdout + stderr;
                
                if (result !== undefined && result !== null) {
                     if (typeof result === 'object' && result.toString) {
                         finalOutput += "\n" + result.toString();
                     } else {
                         finalOutput += "\n" + String(result);
                     }
                }
                updateFileList();

                const hasPlot = outputPlot.children.length > 0;
                const hasText = finalOutput.trim().length > 0;

                if (hasText || hasPlot) {
                    outputText.textContent = finalOutput.trim();
                    outputText.classList.remove('text-red-600');
                    outputText.classList.add('text-gray-700');
                    label.textContent = "Out:";
                    label.classList.remove('text-red-500');
                    label.classList.add('text-gray-400');
                    outputContainer.classList.remove('hidden');
                }
            } catch (err) {
                outputText.textContent = err.message;
                outputText.classList.remove('text-gray-700');
                outputText.classList.add('text-red-600');
                label.textContent = "Err:";
                label.classList.remove('text-gray-400');
                label.classList.add('text-red-500');
                outputContainer.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                document.pyodideMplTarget = null;
            }
        }

        function deleteCell(id) {
            const cell = document.querySelector(`.notebook-cell[data-id="${id}"]`);
            if (cell) {
                // Remove CM instance to prevent memory leak
                if (editors[id]) {
                    // CM doesn't have a strict destroy method for the DOM version, 
                    // but removing the reference allows GC.
                    delete editors[id];
                }
                cell.remove();
                updateIndices();
                saveState();
            }
            if (document.querySelectorAll('.notebook-cell').length === 0) {
                addCell();
            }
        }

        function clearAll() {
            showModal("Reset Notebook", "Are you sure you want to clear all code cells?", true, () => {
                document.getElementById('notebook-container').innerHTML = '';
                localStorage.removeItem(STORAGE_KEY);
                for (const key in editors) delete editors[key];
                addCell();
            });
        }

        function updateIndices() {
            const cells = document.querySelectorAll('.notebook-cell');
            cells.forEach((cell, index) => {
                cell.querySelector('.cell-index').innerText = `In [${index + 1}]`;
            });
        }

        function saveState() {
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                const id = cell.dataset.id;
                if (editors[id]) {
                    cells.push(editors[id].getValue());
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cells));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const contents = JSON.parse(saved);
                if (contents.length > 0) {
                    contents.forEach(content => addCell(content, false));
                    return;
                }
            }
            addCell("# Example: Plotting with Matplotlib\nimport matplotlib.pyplot as plt\nimport numpy as np\n\nx = np.linspace(0, 10, 100)\ny = np.sin(x)\n\nplt.figure(figsize=(6,4))\nplt.plot(x, y)\nplt.title('Sine Wave')\nplt.grid(True)\nplt.show()", false);
        }
    </script>
</body>
</html>