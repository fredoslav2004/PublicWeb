<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Client-Side Executor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .notebook-cell {
            transition: box-shadow 0.2s ease, transform 0.1s ease;
        }
        .notebook-cell:focus-within {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #3b82f6;
        }
        
        .code-input {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            tab-size: 4;
            line-height: 1.5;
        }

        .output-text {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-ready { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-loading { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .status-error { background-color: #ef4444; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* File Sidebar */
        #file-sidebar {
            position: fixed;
            right: -300px;
            top: 60px; /* Height of header roughly */
            bottom: 0;
            width: 300px;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        #file-sidebar.open {
            right: 0;
        }

        /* Matplotlib Canvas Overrides */
        /* Ensure the plot fits within the cell */
        .output-plot div {
            max-width: 100% !important;
            overflow-x: auto;
            box-shadow: none !important; 
        }
        .output-plot canvas {
            max-width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Sidebar / Header -->
    <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm z-10 shrink-0 h-[70px]">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-brands fa-python text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">PyBrowser Lite</h1>
                <div class="text-xs text-gray-500 flex items-center gap-2">
                    <span id="system-status-dot" class="status-dot status-loading"></span>
                    <span id="system-status-text">Initializing...</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <!-- Action Buttons -->
             <button id="btn-upload" onclick="triggerUpload()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Upload File" disabled>
                <i class="fa-solid fa-upload"></i>
            </button>
            <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">

            <button onclick="toggleFileSidebar()" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition-colors relative" title="Show Files">
                <i class="fa-solid fa-folder"></i>
                <span id="file-count-badge" class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full hidden"></span>
            </button>

            <div class="h-6 w-px bg-gray-300 mx-1"></div>

            <button onclick="clearAll()" class="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded transition-colors" title="Reset Notebook">
                <i class="fa-solid fa-trash-can"></i>
            </button>
            <button onclick="addCell()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-medium transition-colors">
                <i class="fa-solid fa-plus mr-1"></i> Cell
            </button>
        </div>
    </div>

    <!-- File Sidebar -->
    <div id="file-sidebar">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h2 class="font-bold text-gray-700"><i class="fa-solid fa-hard-drive mr-2"></i>Files</h2>
            <button onclick="toggleFileSidebar()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="file-list">
            <div class="text-center text-gray-400 text-sm mt-10">No files found</div>
        </div>
        <div class="p-2 border-t border-gray-100 bg-gray-50 text-xs text-center text-gray-500">
            Files stored in memory (Virtual FS)
        </div>
    </div>

    <!-- Main Content -->
    <div id="notebook-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-20 relative">
        <!-- Cells will be injected here -->
    </div>

    <!-- Toast Notification -->
    <div id="toast">Message Here</div>

    <!-- Templates -->
    <template id="cell-template">
        <div class="notebook-cell bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden" data-id="">
            
            <!-- Toolbar -->
            <div class="bg-gray-50 border-b border-gray-100 px-3 py-2 flex justify-between items-center select-none">
                <span class="text-xs font-mono text-gray-400 cell-index">In [ ]</span>
                <div class="flex gap-2">
                    <button class="run-btn text-gray-500 hover:text-green-600 transition-colors p-1" title="Run (Shift+Enter)">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Delete Cell">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <!-- Input -->
            <div class="relative group">
                <textarea class="code-input w-full p-4 outline-none text-sm text-gray-800 bg-white resize-y min-h-[80px]" placeholder="Write Python code here..." spellcheck="false"></textarea>
                <!-- Visual hint for execution -->
                <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-50 transition-opacity pointer-events-none">
                    <span class="text-[10px] bg-gray-200 px-1 rounded text-gray-500">Shift+Enter</span>
                </div>
            </div>

            <!-- Output Container (Hidden by default) -->
            <div class="output-container hidden border-t border-gray-100 bg-gray-50">
                <div class="p-4 text-sm">
                    <div class="flex items-start gap-2">
                        <span class="text-xs font-mono text-red-400 mt-1 select-none output-label">Out:</span>
                        <div class="flex-1 overflow-hidden">
                            <!-- Matplotlib Plot Target -->
                            <div class="output-plot mb-2"></div>
                            <!-- Stdout Text -->
                            <pre class="output-text text-gray-700"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay (Hidden by default) -->
            <div class="loading-overlay absolute inset-0 bg-white/80 z-10 hidden flex items-center justify-center">
                <div class="loader"></div>
            </div>
        </div>
    </template>

    <template id="file-item-template">
        <div class="flex items-center justify-between p-2 hover:bg-blue-50 rounded group transition-colors cursor-default">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fa-regular fa-file-lines text-blue-400"></i>
                <span class="text-sm text-gray-700 font-mono truncate file-name">data.csv</span>
                <span class="text-xs text-gray-400 file-size"></span>
            </div>
            <button class="download-btn text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Download">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
    </template>

    <script>
        let pyodide = null;
        let cellCount = 0;
        const STORAGE_KEY = 'py_notebook_data';

        // --- Initialization ---
        
        async function main() {
            try {
                // Initialize Pyodide
                pyodide = await loadPyodide();
                
                // Setup stdout capture redirection
                await pyodide.runPythonAsync(`
                    import sys
                    import io
                    
                    class JSStream(io.StringIO):
                        def write(self, s):
                            return super().write(s)
                `);

                // UI Updates
                document.getElementById('system-status-dot').className = 'status-dot status-ready';
                document.getElementById('system-status-text').innerText = 'Ready';
                document.getElementById('system-status-text').className = 'text-green-600 font-medium';
                
                document.getElementById('btn-upload').disabled = false;

                // Initial file scan
                updateFileList();

                // Load saved state or create default cell
                loadState();
                
            } catch (err) {
                document.getElementById('system-status-dot').className = 'status-dot status-error';
                document.getElementById('system-status-text').innerText = 'Error';
                console.error("Pyodide failed to load", err);
                alert("Failed to load Python environment.");
            }
        }

        main();

        // --- File System Logic ---
        
        function toggleFileSidebar() {
            const sidebar = document.getElementById('file-sidebar');
            sidebar.classList.toggle('open');
            updateFileList();
        }

        function triggerUpload() {
            document.getElementById('file-upload').click();
        }

        async function handleFileUpload(input) {
            if (input.files.length === 0) return;
            
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const buffer = e.target.result;
                    const data = new Uint8Array(buffer);
                    
                    pyodide.FS.writeFile(file.name, data);
                    
                    showToast(`File "${file.name}" uploaded!`);
                    updateFileList();
                    
                    // Open sidebar to show user where it went
                    document.getElementById('file-sidebar').classList.add('open');
                    
                } catch (err) {
                    console.error(err);
                    showToast("Error: " + err.message);
                }
            };

            reader.readAsArrayBuffer(file);
            input.value = '';
        }

        function updateFileList() {
            if (!pyodide) return;
            
            const listContainer = document.getElementById('file-list');
            const template = document.getElementById('file-item-template');
            
            try {
                const files = pyodide.FS.readdir('.');
                
                // Filter out system dirs
                const visibleFiles = files.filter(f => f !== '.' && f !== '..' && f !== 'tmp' && f !== 'home' && f !== 'dev' && f !== 'proc');

                if (visibleFiles.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm mt-10">No files found.<br>Upload or create one!</div>';
                    return;
                }

                listContainer.innerHTML = '';
                visibleFiles.forEach(filename => {
                    const clone = template.content.cloneNode(true);
                    clone.querySelector('.file-name').innerText = filename;
                    
                    // Try to get size
                    try {
                        const stat = pyodide.FS.stat(filename);
                        if(!pyodide.FS.isDir(stat.mode)) {
                             clone.querySelector('.file-size').innerText = `(${Math.ceil(stat.size/1024)}KB)`;
                        } else {
                            clone.querySelector('.file-size').innerText = '(Dir)';
                        }
                    } catch(e){}

                    clone.querySelector('.download-btn').onclick = () => downloadFile(filename);
                    listContainer.appendChild(clone);
                });
                
                // Update badge
                const badge = document.getElementById('file-count-badge');
                if(visibleFiles.length > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

            } catch(e) {
                console.error("Error reading FS", e);
            }
        }

        function downloadFile(filename) {
            try {
                const content = pyodide.FS.readFile(filename);
                const blob = new Blob([content], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast("Error downloading: " + e.message);
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Core Logic ---

        function createCellElement(id, content = "") {
            const template = document.getElementById('cell-template');
            const clone = template.content.cloneNode(true);
            const cellDiv = clone.querySelector('.notebook-cell');
            cellDiv.dataset.id = id;
            
            const textarea = cellDiv.querySelector('textarea');
            textarea.value = content;
            
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                saveState();
            });

            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.shiftKey) {
                    e.preventDefault();
                    runCell(id);
                }
            });

            cellDiv.querySelector('.run-btn').onclick = () => runCell(id);
            cellDiv.querySelector('.delete-btn').onclick = () => deleteCell(id);

            return cellDiv;
        }

        function addCell(content = "", save = true) {
            cellCount++;
            const id = "cell_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            const container = document.getElementById('notebook-container');
            const cellEl = createCellElement(id, content);
            container.appendChild(cellEl);
            
            if(save) {
                cellEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                saveState();
            }
            
            updateIndices();
            
            if(content) {
                const ta = container.querySelector(`[data-id="${id}"] textarea`);
                ta.style.height = 'auto';
                ta.style.height = (ta.scrollHeight) + 'px';
            }
        }

        async function runCell(id) {
            if (!pyodide) {
                alert("Python is still loading...");
                return;
            }

            const cell = document.querySelector(`.notebook-cell[data-id="${id}"]`);
            if (!cell) return;

            const code = cell.querySelector('textarea').value;
            const outputContainer = cell.querySelector('.output-container');
            const outputText = cell.querySelector('.output-text');
            const outputPlot = cell.querySelector('.output-plot');
            const loader = cell.querySelector('.loading-overlay');
            const label = cell.querySelector('.output-label');

            if (!code.trim()) return;

            // UI State: Running
            loader.classList.remove('hidden');
            outputContainer.classList.add('hidden');
            outputText.textContent = "";
            outputPlot.innerHTML = ""; // Clear previous plots
            
            try {
                // 1. Setup Stdout
                await pyodide.runPythonAsync(`
                    sys.stdout = JSStream()
                    sys.stderr = JSStream()
                `);

                // 2. Setup Matplotlib Target
                // We tell Pyodide where to render any matplotlib plots for this execution
                document.pyodideMplTarget = outputPlot;

                // 3. Load Packages (optimistic)
                await pyodide.loadPackagesFromImports(code);
                
                // 4. Evaluate Code
                let result = await pyodide.runPythonAsync(code);

                // 5. Get Output
                let stdout = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                let stderr = await pyodide.runPythonAsync("sys.stderr.getvalue()");
                let finalOutput = stdout + stderr;
                
                if (result !== undefined && result !== null) {
                     if (typeof result === 'object' && result.toString) {
                         finalOutput += "\n" + result.toString();
                     } else {
                         finalOutput += "\n" + String(result);
                     }
                }

                // 6. Update File List (in case code generated files)
                updateFileList();

                // 7. Display Results
                const hasPlot = outputPlot.children.length > 0;
                const hasText = finalOutput.trim().length > 0;

                if (hasText || hasPlot) {
                    outputText.textContent = finalOutput.trim();
                    
                    // Styling updates
                    outputText.classList.remove('text-red-600');
                    outputText.classList.add('text-gray-700');
                    label.textContent = "Out:";
                    label.classList.remove('text-red-500');
                    label.classList.add('text-gray-400');
                    outputContainer.classList.remove('hidden');
                }

            } catch (err) {
                outputText.textContent = err.message;
                outputText.classList.remove('text-gray-700');
                outputText.classList.add('text-red-600');
                label.textContent = "Err:";
                label.classList.remove('text-gray-400');
                label.classList.add('text-red-500');
                outputContainer.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                // Reset target to null so background tasks don't accidentally draw here
                document.pyodideMplTarget = null;
            }
        }

        function deleteCell(id) {
            const cell = document.querySelector(`.notebook-cell[data-id="${id}"]`);
            if (cell) {
                cell.remove();
                updateIndices();
                saveState();
            }
            if (document.querySelectorAll('.notebook-cell').length === 0) {
                addCell();
            }
        }

        function clearAll() {
            if(confirm("Clear all code and reset?")) {
                document.getElementById('notebook-container').innerHTML = '';
                localStorage.removeItem(STORAGE_KEY);
                addCell();
            }
        }

        function updateIndices() {
            const cells = document.querySelectorAll('.notebook-cell');
            cells.forEach((cell, index) => {
                cell.querySelector('.cell-index').innerText = `In [${index + 1}]`;
            });
        }

        function saveState() {
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                cells.push(cell.querySelector('textarea').value);
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cells));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const contents = JSON.parse(saved);
                if (contents.length > 0) {
                    contents.forEach(content => addCell(content, false));
                    return;
                }
            }
            // Default Sample
            addCell("# Example: Plotting with Matplotlib\nimport matplotlib.pyplot as plt\nimport numpy as np\n\nx = np.linspace(0, 10, 100)\ny = np.sin(x)\n\nplt.figure(figsize=(6,4))\nplt.plot(x, y)\nplt.title('Sine Wave')\nplt.grid(True)\nplt.show()", false);
        }

    </script>
</body>
</html>